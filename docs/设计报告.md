# 图片管理系统设计报告

## 1. 项目概述

### 1.1 项目目标
构建一个功能完善的图片管理系统，支持用户注册登录、图片上传、自动分类、标签管理、查询检索、图片编辑等功能，并适配PC端和移动端浏览器。

### 1.2 技术栈
- **前端**: React 18+ + Vite + TypeScript
- **后端**: Golang (Gin框架)
- **数据库**: MySQL 8.0+
- **图片处理**: Go图像处理库 (imaging/graphics-go) 或调用外部服务
- **EXIF解析**: go-exif库

### 1.3 核心功能
1. 用户认证系统（注册、登录）
2. 图片上传（支持PC和移动端）
3. EXIF信息提取与自动分类
4. 自定义标签管理
5. 缩略图生成与存储
6. 图片信息数据库存储
7. 多条件查询检索
8. 图片展示（轮播、网格）
9. 图片编辑（裁剪、色调调整）
10. 图片删除
11. 响应式设计（移动端适配）

---

## 2. 系统架构设计

### 2.1 整体架构
```
┌─────────────────┐
│   前端 (React)   │
│   Vite + TS     │
└────────┬────────┘
         │ HTTP/HTTPS
         │ RESTful API
┌────────▼────────┐
│  后端 (Golang)   │
│   Gin Framework │
└────────┬────────┘
         │
    ┌────┴────┐
    │         │
┌───▼───┐ ┌──▼────┐
│ MySQL │ │ 文件  │
│ 数据库 │ │ 存储  │
└───────┘ └───────┘
```

### 2.2 模块划分

#### 2.2.1 前端模块
- **认证模块**: 登录、注册页面
- **上传模块**: 图片上传组件（支持拖拽、选择文件）
- **展示模块**: 图片列表、网格视图、轮播视图
- **查询模块**: 搜索、筛选组件
- **编辑模块**: 图片编辑器（裁剪、色调调整）
- **标签模块**: 标签管理界面
- **用户模块**: 用户信息管理

#### 2.2.2 后端模块
- **用户服务**: 注册、登录、JWT认证
- **图片服务**: 上传、存储、删除
- **EXIF服务**: 提取图片元数据
- **标签服务**: 标签CRUD操作
- **查询服务**: 多条件查询逻辑
- **缩略图服务**: 生成和存储缩略图
- **编辑服务**: 图片处理（裁剪、色调）

---

## 3. 数据库设计

### 3.1 用户表 (users)
```sql
CREATE TABLE users (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,  -- bcrypt加密
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_username (username),
    INDEX idx_email (email)
);
```

### 3.2 图片表 (images)
```sql
CREATE TABLE images (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    original_filename VARCHAR(255) NOT NULL,
    stored_filename VARCHAR(255) NOT NULL,  -- 服务器存储的文件名
    file_path VARCHAR(500) NOT NULL,  -- 原始图片存储路径
    thumbnail_path VARCHAR(500),  -- 缩略图存储路径（如果存储在文件系统）
    mime_type VARCHAR(50) NOT NULL,
    file_size BIGINT NOT NULL,  -- 字节数
    width INT,
    height INT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    INDEX idx_user_id (user_id),
    INDEX idx_created_at (created_at)
);   
```

### 3.3 EXIF信息表 (image_exif)
```sql
CREATE TABLE image_exif (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    image_id BIGINT NOT NULL,
    camera_make VARCHAR(100),
    camera_model VARCHAR(100),
    taken_at DATETIME,  -- 拍摄时间
    latitude DECIMAL(10, 8),  -- 纬度
    longitude DECIMAL(11, 8),  -- 经度
    location_name VARCHAR(200),  -- 地点名称（可通过经纬度反向地理编码）
    orientation INT,  -- 方向信息
    iso INT,
    aperture VARCHAR(20),
    shutter_speed VARCHAR(20),
    focal_length VARCHAR(20),
    flash VARCHAR(50),
    exif_data JSON,  -- 其他EXIF信息的JSON存储
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (image_id) REFERENCES images(id) ON DELETE CASCADE,
    INDEX idx_image_id (image_id),
    INDEX idx_taken_at (taken_at),
    INDEX idx_location (latitude, longitude)
);
```

### 3.4 标签表 (tags)
```sql
CREATE TABLE tags (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,  -- 标签属于哪个用户
    name VARCHAR(50) NOT NULL,
    color VARCHAR(7),  -- 标签颜色（十六进制，如#FF5733）
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE KEY unique_user_tag (user_id, name),  -- 同一用户的标签名唯一
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    INDEX idx_user_id (user_id),
    INDEX idx_name (name)
);
```

### 3.5 图片标签关联表 (image_tags)
```sql
CREATE TABLE image_tags (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    image_id BIGINT NOT NULL,
    tag_id BIGINT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (image_id) REFERENCES images(id) ON DELETE CASCADE,
    FOREIGN KEY (tag_id) REFERENCES tags(id) ON DELETE CASCADE,
    UNIQUE KEY unique_image_tag (image_id, tag_id),
    INDEX idx_image_id (image_id),
    INDEX idx_tag_id (tag_id)
);
```

### 3.6 缩略图表 (thumbnails)
```sql
CREATE TABLE thumbnails (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    image_id BIGINT NOT NULL,
    thumbnail_data LONGBLOB NOT NULL,  -- 缩略图二进制数据
    width INT NOT NULL,
    height INT NOT NULL,
    size INT NOT NULL,  -- 缩略图大小（字节）
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (image_id) REFERENCES images(id) ON DELETE CASCADE,
    UNIQUE KEY unique_image_thumbnail (image_id),
    INDEX idx_image_id (image_id)
);
```

**注意**: 缩略图存储在数据库中，虽然可能影响性能，但便于管理和备份。如果性能成为瓶颈，可考虑迁移到文件系统或对象存储。

---

## 4. 后端API设计

### 4.1 认证相关API

#### 4.1.1 用户注册
```
POST /api/v1/auth/register
Request Body:
{
    "username": "string (>=6字符)",
    "email": "string (有效邮箱格式)",
    "password": "string (>=6字符)"
}
Response:
{
    "code": 200,
    "message": "注册成功",
    "data": {
        "user_id": 1,
        "username": "user123"
    }
}
```

#### 4.1.2 用户登录
```
POST /api/v1/auth/login
Request Body:
{
    "username": "string",
    "password": "string"
}
Response:
{
    "code": 200,
    "message": "登录成功",
    "data": {
        "token": "JWT_TOKEN",
        "user": {
            "id": 1,
            "username": "user123",
            "email": "user@example.com"
        }
    }
}
```

#### 4.1.3 验证Token
```
GET /api/v1/auth/verify
Headers: Authorization: Bearer {token}
Response:
{
    "code": 200,
    "data": {
        "valid": true,
        "user": {...}
    }
}
```

### 4.2 图片相关API

#### 4.2.1 上传图片
```
POST /api/v1/images/upload
Headers: 
    Authorization: Bearer {token}
    Content-Type: multipart/form-data
Form Data:
    file: File (图片文件)
    tags: string[] (可选，自定义标签数组)
Response:
{
    "code": 200,
    "message": "上传成功",
    "data": {
        "image_id": 1,
        "filename": "image.jpg",
        "exif": {
            "taken_at": "2024-01-01T12:00:00Z",
            "location": "北京市",
            "camera": "Canon EOS 5D"
        },
        "auto_tags": ["2024年", "1月", "北京"],
        "thumbnail_url": "/api/v1/images/1/thumbnail"
    }
}
```

#### 4.2.2 获取图片列表
```
GET /api/v1/images?page=1&page_size=20&tag_id=1&start_date=2024-01-01&end_date=2024-12-31&keyword=xxx
Headers: Authorization: Bearer {token}
Query Parameters:
    page: int (页码，默认1)
    page_size: int (每页数量，默认20)
    tag_id: int (标签ID，可选)
    start_date: string (开始日期，可选)
    end_date: string (结束日期，可选)
    keyword: string (关键词搜索，可选，搜索文件名)
    location: string (地点，可选)
Response:
{
    "code": 200,
    "data": {
        "total": 100,
        "page": 1,
        "page_size": 20,
        "images": [
            {
                "id": 1,
                "filename": "image.jpg",
                "thumbnail_url": "/api/v1/images/1/thumbnail",
                "original_url": "/api/v1/images/1/original",
                "width": 1920,
                "height": 1080,
                "taken_at": "2024-01-01T12:00:00Z",
                "location": "北京市",
                "tags": [{"id": 1, "name": "风景", "color": "#FF5733"}],
                "created_at": "2024-01-01T12:00:00Z"
            }
        ]
    }
}
```

#### 4.2.3 获取单张图片详情
```
GET /api/v1/images/:id
Headers: Authorization: Bearer {token}
Response:
{
    "code": 200,
    "data": {
        "id": 1,
        "filename": "image.jpg",
        "original_url": "/api/v1/images/1/original",
        "width": 1920,
        "height": 1080,
        "file_size": 2048000,
        "exif": {
            "camera": "Canon EOS 5D",
            "taken_at": "2024-01-01T12:00:00Z",
            "location": "北京市",
            "latitude": 39.9042,
            "longitude": 116.4074,
            "iso": 100,
            "aperture": "f/2.8",
            "shutter_speed": "1/125"
        },
        "tags": [...],
        "created_at": "2024-01-01T12:00:00Z"
    }
}
```

#### 4.2.4 获取缩略图
```
GET /api/v1/images/:id/thumbnail
Headers: Authorization: Bearer {token}
Response: 图片二进制流 (Content-Type: image/jpeg)
```

#### 4.2.5 获取原始图片
```
GET /api/v1/images/:id/original
Headers: Authorization: Bearer {token}
Response: 图片二进制流 (Content-Type: image/jpeg)
```

#### 4.2.6 删除图片
```
DELETE /api/v1/images/:id
Headers: Authorization: Bearer {token}
Response:
{
    "code": 200,
    "message": "删除成功"
}
```

### 4.3 标签相关API

#### 4.3.1 创建标签
```
POST /api/v1/tags
Headers: Authorization: Bearer {token}
Request Body:
{
    "name": "风景",
    "color": "#FF5733"
}
Response:
{
    "code": 200,
    "data": {
        "id": 1,
        "name": "风景",
        "color": "#FF5733"
    }
}
```

#### 4.3.2 获取用户所有标签
```
GET /api/v1/tags
Headers: Authorization: Bearer {token}
Response:
{
    "code": 200,
    "data": [
        {"id": 1, "name": "风景", "color": "#FF5733"},
        {"id": 2, "name": "人物", "color": "#33FF57"}
    ]
}
```

#### 4.3.3 更新标签
```
PUT /api/v1/tags/:id
Headers: Authorization: Bearer {token}
Request Body:
{
    "name": "新名称",
    "color": "#000000"
}
```

#### 4.3.4 删除标签
```
DELETE /api/v1/tags/:id
Headers: Authorization: Bearer {token}
```

#### 4.3.5 为图片添加标签
```
POST /api/v1/images/:id/tags
Headers: Authorization: Bearer {token}
Request Body:
{
    "tag_ids": [1, 2, 3]
}
```

#### 4.3.6 移除图片标签
```
DELETE /api/v1/images/:id/tags/:tag_id
Headers: Authorization: Bearer {token}
```

### 4.4 图片编辑API

#### 4.4.1 裁剪图片
```
POST /api/v1/images/:id/crop
Headers: Authorization: Bearer {token}
Request Body:
{
    "x": 100,
    "y": 100,
    "width": 800,
    "height": 600
}
Response:
{
    "code": 200,
    "data": {
        "image_id": 1,
        "new_image_id": 2,  // 裁剪后生成新图片
        "url": "/api/v1/images/2/original"
    }
}
```

#### 4.4.2 调整色调
```
POST /api/v1/images/:id/adjust
Headers: Authorization: Bearer {token}
Request Body:
{
    "brightness": 10,  // -100 到 100
    "contrast": 5,     // -100 到 100
    "saturation": 20,  // -100 到 100
    "hue": 0           // -180 到 180
}
Response:
{
    "code": 200,
    "data": {
        "image_id": 1,
        "new_image_id": 3,
        "url": "/api/v1/images/3/original"
    }
}
```

---

## 5. 前端设计

### 5.1 技术选型
- **框架**: React 18+ with TypeScript
- **构建工具**: Vite
- **路由**: React Router v6
- **状态管理**: Zustand 或 React Context API
- **UI组件库**: Ant Design Mobile / Material-UI (响应式)
- **图片处理**: react-image-crop, react-image-gallery
- **HTTP客户端**: Axios
- **表单验证**: react-hook-form + zod

### 5.2 页面结构

#### 5.2.1 路由设计
```
/                    -> 首页（重定向到登录或图片列表）
/login               -> 登录页
/register            -> 注册页
/images              -> 图片列表页
/images/:id          -> 图片详情页
/images/:id/edit     -> 图片编辑页
/upload              -> 上传页
/tags                -> 标签管理页
```

#### 5.2.2 组件设计

**布局组件**
- `Layout`: 主布局（包含导航栏、侧边栏）
- `Header`: 顶部导航栏
- `Sidebar`: 侧边栏（移动端可折叠）
- `Footer`: 页脚

**认证组件**
- `LoginForm`: 登录表单
- `RegisterForm`: 注册表单（包含验证）

**图片相关组件**
- `ImageUploader`: 图片上传组件（支持拖拽、多选）
- `ImageList`: 图片列表（网格/列表视图切换）
- `ImageCard`: 单张图片卡片
- `ImageGallery`: 图片轮播/画廊组件
- `ImageDetail`: 图片详情页
- `ImageEditor`: 图片编辑器（裁剪、色调调整）
- `ThumbnailView`: 缩略图视图

**查询组件**
- `SearchBar`: 搜索栏
- `FilterPanel`: 筛选面板（日期、标签、地点等）
- `TagSelector`: 标签选择器

**标签组件**
- `TagList`: 标签列表
- `TagEditor`: 标签编辑器
- `TagBadge`: 标签徽章

---

## 6. 功能模块详细设计

### 6.1 用户注册登录模块

#### 6.1.1 注册功能
**前端验证规则**:
- 用户名：6-50字符，只能包含字母、数字、下划线
- 密码：至少6字符，建议包含字母和数字
- 邮箱：标准邮箱格式验证

**后端验证**:
- 检查用户名唯一性
- 检查邮箱唯一性
- 密码使用bcrypt加密存储
- 返回JWT Token

#### 6.1.2 登录功能
- 支持用户名或邮箱登录
- JWT Token认证
- Token过期时间：7天（可配置）
- 前端自动保存Token到localStorage

### 6.2 图片上传模块

#### 6.2.1 上传流程
1. 用户选择/拖拽图片文件
2. 前端验证文件类型（jpg, png, gif, webp等）
3. 前端验证文件大小（限制最大10MB）
4. 显示上传进度
5. 后端接收文件，保存到文件系统
6. 提取EXIF信息
7. 生成缩略图（建议尺寸：300x300，保持宽高比）
8. 将缩略图存储到数据库
9. 根据EXIF信息自动创建标签
10. 返回图片信息和自动标签

#### 6.2.2 EXIF信息提取
**提取字段**:
- 拍摄时间 (DateTimeOriginal)
- GPS信息 (GPSLatitude, GPSLongitude)
- 相机信息 (Make, Model)
- 拍摄参数 (ISO, Aperture, ShutterSpeed, FocalLength)
- 图片尺寸 (ImageWidth, ImageHeight)
- 方向 (Orientation)

**自动标签生成规则**:
- 根据拍摄时间生成：年份标签（如"2024年"）、月份标签（如"1月"）
- 根据GPS信息生成：地点标签（通过反向地理编码API）
- 根据相机型号生成：设备标签（如"Canon EOS 5D"）

### 6.3 缩略图生成模块

#### 6.3.1 生成策略
- 标准尺寸：300x300像素（保持宽高比，居中裁剪或填充）
- 格式：JPEG，质量：85%
- 存储：LONGBLOB字段

#### 6.3.2 性能优化
- 异步生成，不阻塞上传流程
- 如果生成失败，使用原图压缩版本作为缩略图
- 考虑缓存机制

### 6.4 标签管理模块

#### 6.4.1 自动标签
- 系统自动创建，用户可删除
- 标签类型：时间、地点、设备等

#### 6.4.2 自定义标签
- 用户创建，可设置名称和颜色
- 同一用户标签名唯一
- 支持为图片批量添加/移除标签

### 6.5 查询检索模块

#### 6.5.1 查询条件
- 关键词搜索（文件名）
- 标签筛选（多选）
- 日期范围
- 地点筛选
- 设备筛选
- 组合查询

#### 6.5.2 查询优化
- 数据库索引优化
- 分页加载
- 前端虚拟滚动（大量数据时）

### 6.6 图片展示模块

#### 6.6.1 列表视图
- 网格布局（响应式列数）
- 每张图片显示缩略图、文件名、标签、拍摄时间
- 点击进入详情页

#### 6.6.2 轮播视图
- 支持左右滑动（移动端手势）
- 显示图片信息（EXIF、标签）
- 支持全屏查看

### 6.7 图片编辑模块

#### 6.7.1 裁剪功能
- 自由裁剪或固定比例
- 实时预览
- 保存为新图片（保留原图）

#### 6.7.2 色调调整
- 亮度调整（-100 到 100）
- 对比度调整（-100 到 100）
- 饱和度调整（-100 到 100）
- 色相调整（-180 到 180）
- 实时预览
- 保存为新图片

### 6.8 删除功能
- 软删除或硬删除（建议硬删除）
- 删除时同时删除：
  - 原图文件
  - 缩略图（数据库记录）
  - EXIF记录
  - 标签关联
- 支持批量删除

---

## 7. 安全设计

### 7.1 认证安全
- JWT Token认证
- Token过期机制
- 密码bcrypt加密（cost factor: 10）
- 登录失败次数限制（防止暴力破解）

### 7.2 文件上传安全
- 文件类型白名单验证
- 文件大小限制
- 文件名安全处理（防止路径遍历）
- 病毒扫描（可选）

### 7.3 API安全
- CORS配置
- 请求频率限制（Rate Limiting）
- SQL注入防护（使用参数化查询）
- XSS防护（输入输出转义）

### 7.4 数据安全
- 用户只能访问自己的图片
- 图片URL包含Token验证（可选）
- 敏感信息加密存储